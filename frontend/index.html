<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FileBeam ‚Äì Env√≠o de archivos</title>
  <link href="./src/output.css" rel="stylesheet" />
</head>
<body class="min-h-screen bg-slate-50">
  <header class="bg-white border-b">
    <div class="max-w-5xl mx-auto px-4 py-6 flex items-center justify-between">
      <h1 class="text-2xl font-semibold text-slate-800">üì¶ FileBeam</h1>
      <span class="text-sm text-slate-500">FastAPI + Tailwind</span>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4 py-8 space-y-8">
    <!-- Uploader -->
    <section class="bg-white rounded-2xl shadow p-6">
      <h2 class="text-lg font-semibold text-slate-800 mb-4">Subir archivo</h2>

      <!-- Zona drag & drop -->
      <div id="drop" class="border-2 border-dashed rounded-2xl p-8 text-center cursor-pointer
                           border-slate-300 hover:border-slate-400 transition">
        <p class="text-slate-700 mb-2">Arrastra aqu√≠ tu archivo</p>
        <p class="text-sm text-slate-500">o haz clic para seleccionar</p>
        <input id="fileInput" type="file" class="hidden" />
      </div>

      <!-- Botones -->
      <div class="mt-4 flex items-center gap-3">
        <button id="sendBtn"
          class="px-4 py-2 rounded-2xl bg-slate-900 text-white text-sm hover:bg-slate-800 disabled:opacity-50">
          ‚¨ÜÔ∏è Subir
        </button>
        <span id="statusText" class="text-sm text-slate-500"></span>
      </div>

      <!-- Progreso -->
      <div id="progressWrap" class="hidden mt-4">
        <div class="w-full bg-slate-200 rounded-full h-3 overflow-hidden">
          <div id="progressBar" class="h-3 bg-blue-500 rounded-full transition-all" style="width:0%"></div>
        </div>
        <div class="mt-2 flex justify-between text-xs text-slate-500">
          <span id="progressPct">0%</span>
          <span id="progressBytes">0 / 0</span>
        </div>
      </div>

      <!-- Resultado -->
      <div id="resultCard" class="hidden mt-6 border rounded-2xl p-4 bg-slate-50">
        <div class="flex justify-between items-start gap-4">
          <div class="text-left">
            <h3 class="font-semibold text-slate-800" id="resName">archivo.ext</h3>
            <p class="text-sm text-slate-600">SHA-256: <code class="break-all" id="resHash">‚Äî</code></p>
          </div>
          <div class="text-right">
            <span class="text-sm text-slate-500" id="resBytes">‚Äî</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Listado -->
    <section class="bg-white rounded-2xl shadow p-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold text-slate-800">Archivos en el servidor</h2>
        <button id="refreshBtn" class="text-sm rounded-xl px-3 py-1.5 bg-slate-100 hover:bg-slate-200">Actualizar</button>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="text-left text-slate-500">
            <tr>
              <th class="py-2 pr-4">Nombre</th>
              <th class="py-2 pr-4">Tama√±o</th>
              <th class="py-2">Acciones</th>
            </tr>
          </thead>
          <tbody id="filesTBody" class="align-top"></tbody>
        </table>
      </div>
    </section>
  </main>

  <footer class="py-8 text-center text-xs text-slate-400">¬© 2025 FileBeam</footer>

  <script>
    // ===== Config =====
    const API_BASE =  `${location.protocol}//${location.hostname}:8000`; // backend FastAPI
    const API_KEY = ""; // si activas API key en el backend, coloca aqu√≠ el valor

    // ===== Helpers =====
    const $ = (id) => document.getElementById(id);
    const human = (n) => {
      const u = ["B","KB","MB","GB","TB"]; let i=0;
      while(n>=1024 && i<u.length-1){ n/=1024; i++; }
      return `${n.toFixed(2)} ${u[i]}`;
    };

    // ===== DOM refs =====
    const drop = $("drop");
    const fileInput = $("fileInput");
    const sendBtn = $("sendBtn");
    const statusText = $("statusText");
    const progressWrap = $("progressWrap");
    const progressBar = $("progressBar");
    const progressPct = $("progressPct");
    const progressBytes = $("progressBytes");
    const resultCard = $("resultCard");
    const resName = $("resName");
    const resHash = $("resHash");
    const resBytes = $("resBytes");
    const filesTBody = $("filesTBody");
    const refreshBtn = $("refreshBtn");

    let pendingFile = null;

    // ===== Drag & drop =====
    ["dragenter","dragover"].forEach(ev =>
      drop.addEventListener(ev, e => { e.preventDefault(); drop.classList.add("border-blue-400"); })
    );
    ["dragleave","drop"].forEach(ev =>
      drop.addEventListener(ev, e => { e.preventDefault(); drop.classList.remove("border-blue-400"); })
    );
    drop.addEventListener("click", ()=> fileInput.click());
    drop.addEventListener("drop", (e)=>{
      if(e.dataTransfer.files.length){
        pendingFile = e.dataTransfer.files[0];
        statusText.textContent = `Seleccionado: ${pendingFile.name} (${human(pendingFile.size)})`;
      }
    });
    fileInput.addEventListener("change", ()=>{
      if(fileInput.files.length){
        pendingFile = fileInput.files[0];
        statusText.textContent = `Seleccionado: ${pendingFile.name} (${human(pendingFile.size)})`;
      }
    });

    // ===== Listado =====
    async function refreshList(){
      filesTBody.innerHTML = '<tr><td class="py-3 text-slate-500" colspan="3">Cargando‚Ä¶</td></tr>';
      const r = await fetch(`${API_BASE}/api/list`);
      const data = await r.json();
      filesTBody.innerHTML = "";
      if(!data.files.length){
        filesTBody.innerHTML = '<tr><td class="py-3 text-slate-500" colspan="3">No hay archivos.</td></tr>';
        return;
      }
      for(const f of data.files){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="py-2 pr-4">${f.name}</td>
          <td class="py-2 pr-4 text-slate-500">${human(f.bytes)}</td>
          <td class="py-2">
            <a class="inline-flex items-center rounded-xl px-3 py-1.5 bg-slate-900 text-white text-xs hover:bg-slate-800"
               href="${API_BASE}/api/download/${encodeURIComponent(f.name)}">Descargar</a>
          </td>`;
        filesTBody.appendChild(tr);
      }
    }

    // ===== Subida con progreso =====
    sendBtn.addEventListener("click", ()=>{
      if(!pendingFile){ alert("Selecciona un archivo primero."); return; }
      resultCard.classList.add("hidden");
      progressWrap.classList.remove("hidden");
      statusText.textContent = "Subiendo‚Ä¶";
      sendBtn.disabled = true;

      const formData = new FormData();
      formData.append("file", pendingFile);

      const xhr = new XMLHttpRequest();
      xhr.open("POST", `${API_BASE}/api/upload`);

      // Si usas API key, descomenta:
      // if (API_KEY) xhr.setRequestHeader("x-api-key", API_KEY);

      xhr.upload.onprogress = (ev)=>{
        if(ev.lengthComputable){
          const pct = Math.round((ev.loaded/ev.total)*100);
          progressBar.style.width = pct + "%";
          progressPct.textContent = pct + "%";
          progressBytes.textContent = `${human(ev.loaded)} / ${human(ev.total)}`;
        }
      };

      xhr.onload = ()=>{
        sendBtn.disabled = false;
        statusText.textContent = "";
        if(xhr.status >= 200 && xhr.status < 300){
          const res = JSON.parse(xhr.responseText);
          resName.textContent = res.filename;
          resHash.textContent = res.sha256;
          resBytes.textContent = res.size_human || human(res.bytes);
          resultCard.classList.remove("hidden");
          refreshList();
        } else {
          alert("Error al subir: " + xhr.status + " " + xhr.responseText);
        }
      };

      xhr.onerror = ()=>{
        sendBtn.disabled = false;
        statusText.textContent = "";
        alert("No se pudo conectar con el servidor.");
      };

      xhr.send(formData);
    });

    refreshBtn.addEventListener("click", refreshList);
    refreshList();
  </script>
</body>
</html>
